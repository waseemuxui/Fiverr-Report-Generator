<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Fiverr Order Report Maker</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script type="importmap">
    {
      "imports": {
        "react/": "https://aistudiocdn.com/react@19.2.0/",
        "react": "https://aistudiocdn.com/react@19.2.0",
        "react-dom/client": "https://aistudiocdn.com/react-dom@19.2.0/client",
        "@google/genai": "https://aistudiocdn.com/@google/genai@1.29.0",
        "jspdf": "https://esm.sh/jspdf@2.5.1",
        "jspdf-autotable": "https://esm.sh/jspdf-autotable@3.8.2"
      }
    }
    </script>
    <style>
      /* Simple style for number and date inputs to match the theme */
      .themed-input {
        background-color: #1e293b; /* slate-800 */
        border: 1px solid #475569; /* slate-600 */
        border-radius: 0.375rem; /* rounded-md */
        padding: 0.25rem 0.5rem;
        color: #cbd5e1; /* slate-300 */
        transition: border-color 0.2s, box-shadow 0.2s;
      }
      .themed-input:focus {
        outline: none;
        border-color: #6366f1; /* indigo-500 */
        box-shadow: 0 0 0 2px rgba(99, 102, 241, 0.5);
      }
      /* Fix for date picker icon color in dark mode */
      input[type="date"]::-webkit-calendar-picker-indicator {
        filter: invert(0.8);
      }
      /* Webkit browsers styles for number input */
      .themed-input::-webkit-inner-spin-button,
      .themed-input::-webkit-outer-spin-button {
        -webkit-appearance: none;
        margin: 0;
      }
      .themed-input {
        -moz-appearance: textfield;
      }
      .cost-input {
        width: 100px;
        text-align: right;
      }
      @keyframes fadeIn {
        from { opacity: 0; transform: translateY(-10px); }
        to { opacity: 1; transform: translateY(0); }
      }
      .animate-fadeIn {
        animation: fadeIn 0.3s ease-out forwards;
      }
    </style>
</head>
<body class="bg-slate-900 text-slate-200">
    <div id="root"></div>
    <script type="text/babel" data-type="module">
        import React, { useState, useMemo } from 'react';
        import ReactDOM from 'react-dom/client';
        import { GoogleGenAI, Type } from "@google/genai";
        // FIXED: Use named import for jspdf from esm.sh
        import { jsPDF } from 'jspdf';
        import autoTable from 'jspdf-autotable';

        const EXCHANGE_RATE = 278; // Default estimated exchange rate USD to PKR

        // --- ICONS ---
        const SparklesIcon = ({ className }) => (
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor" className={className}>
            <path strokeLinecap="round" strokeLinejoin="round" d="M9.813 15.904 9 18.75l-.813-2.846a4.5 4.5 0 0 0-3.09-3.09L2.25 12l2.846-.813a4.5 4.5 0 0 0 3.09-3.09L9 5.25l.813 2.846a4.5 4.5 0 0 0 3.09 3.09L15.75 12l-2.846.813a4.5 4.5 0 0 0-3.09 3.09ZM18.259 8.715 18 9.75l-.259-1.035a3.375 3.375 0 0 0-2.455-2.456L14.25 6l1.036-.259a3.375 3.375 0 0 0 2.455-2.456L18 2.25l.259 1.035a3.375 3.375 0 0 0 2.456 2.456L21.75 6l-1.035.259a3.375 3.375 0 0 0-2.456 2.456Z" />
          </svg>
        );

        const ClearIcon = ({ className }) => (
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor" className={className}>
                <path strokeLinecap="round" strokeLinejoin="round" d="M12 9.75 14.25 12m0 0 2.25 2.25M14.25 12 12 14.25m-2.58 4.92-6.374-6.375a1.125 1.125 0 0 1 0-1.59L9.42 4.83c.21-.211.497-.33.795-.33H19.5a2.25 2.25 0 0 1 2.25 2.25v10.5a2.25 2.25 0 0 1-2.25 2.25h-9.284c-.298 0-.585-.119-.795-.33Z" />
            </svg>
        );
        
        const DownloadIcon = ({ className }) => (
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor" className={className}>
                <path strokeLinecap="round" strokeLinejoin="round" d="M3 16.5v2.25A2.25 2.25 0 0 0 5.25 21h13.5A2.25 2.25 0 0 0 21 18.75V16.5M16.5 12 12 16.5m0 0L7.5 12m4.5 4.5V3" />
            </svg>
        );

        const AlertIcon = ({ className }) => (
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" className={className}>
            <path fillRule="evenodd" d="M9.401 3.003c1.155-2 4.043-2 5.197 0l7.355 12.748c1.154 2-.29 4.5-2.599 4.5H4.645c-2.309 0-3.752-2.5-2.598-4.5L9.4 3.003ZM12 8.25a.75.75 0 0 1 .75.75v3.75a.75.75 0 0 1-1.5 0V9a.75.75 0 0 1 .75-.75Zm0 8.25a.75.75 0 1 0 0-1.5.75.75 0 0 0 0 1.5Z" clipRule="evenodd" />
          </svg>
        );
        
        // --- GEMINI SERVICE & ERROR HANDLING ---
        const ai = new GoogleGenAI({ apiKey: process.env.API_KEY });

        const orderSchema = {
          type: Type.ARRAY,
          items: {
            type: Type.OBJECT,
            properties: {
              clientName: { type: Type.STRING, description: "The client's username." },
              description: { type: Type.STRING, description: "A concise description of the service provided." },
              date: { type: Type.STRING, description: "The date of the order, e.g., 'Nov 10'." },
              value: { type: Type.NUMBER, description: "The total numerical value of the order, including tips. Exclude $0 items." },
              status: { type: Type.STRING, description: "The current status of the order, e.g., 'Completed' or 'In Revision'." },
            },
            required: ["clientName", "description", "date", "value", "status"],
          },
        };

        const getFriendlyErrorMessage = (error) => {
            const msg = (error.message || error.toString()).toLowerCase();
            
            // Network / Connectivity
            if (msg.includes("fetch failed") || msg.includes("network")) {
                return {
                    title: "Network Error",
                    message: "Unable to reach the AI service.",
                    suggestion: "Please check your internet connection and try again."
                };
            }
            
            // API Specific
            if (msg.includes("401") || msg.includes("api key")) {
                return {
                    title: "Authentication Error",
                    message: "The API Key provided is invalid.",
                    suggestion: "Please check your environment configuration."
                };
            }
            if (msg.includes("429") || msg.includes("quota")) {
                return {
                    title: "Rate Limit Exceeded",
                    message: "Too many requests in a short time.",
                    suggestion: "Please wait a minute before trying again."
                };
            }
            if (msg.includes("500") || msg.includes("503") || msg.includes("overloaded")) {
                return {
                    title: "Service Unavailable",
                    message: "Google Gemini service is temporarily overloaded or down.",
                    suggestion: "Please try again in a few moments."
                };
            }
            if (msg.includes("400") || msg.includes("invalid argument")) {
                return {
                    title: "Invalid Request",
                    message: "The input text may be too long or malformed.",
                    suggestion: "Try processing a smaller chunk of text."
                };
            }

            // Parsing / Data
            if (msg.includes("json_parse_error") || msg.includes("syntaxerror")) {
                return {
                    title: "Parsing Failed",
                    message: "The AI response could not be understood.",
                    suggestion: "Your input might be ambiguous. Try cleaning up headers or extra text and try again."
                };
            }
            if (msg.includes("invalid_schema_format") || msg.includes("json array")) {
                return {
                    title: "Format Error",
                    message: "The AI did not return a valid list of orders.",
                    suggestion: "Ensure the pasted text contains recognizable order data structure."
                };
            }
            if (msg.includes("safety") || msg.includes("blocked")) {
                return {
                    title: "Content Blocked",
                    message: "The AI refused to process the content due to safety settings.",
                    suggestion: "Ensure your input data does not contain sensitive or prohibited content."
                };
            }

            // Default
            return {
                title: "Unexpected Error",
                message: error.message || "An unknown error occurred.",
                suggestion: "Please try again or refresh the page."
            };
        };

        const parseOrderData = async (text) => {
          const prompt = `Parse the following Fiverr order report text into a structured JSON array. For each order, extract clientName, description, date, status, and calculate the total value by summing the base price and any tips. Ignore $0 items like 'Extend Delivery'. Adhere strictly to the provided JSON schema. Text to parse: \n---\n${text}\n---`;

          try {
            const response = await ai.models.generateContent({
              model: "gemini-2.5-flash",
              contents: prompt,
              config: {
                responseMimeType: "application/json",
                responseSchema: orderSchema,
              },
            });

            const jsonString = response.text.trim();
            let parsedData;
            try {
                parsedData = JSON.parse(jsonString);
            } catch (e) {
                // Label specific parsing errors so helper can identify them
                throw new Error("JSON_PARSE_ERROR: " + e.message);
            }
            
            if (!Array.isArray(parsedData)) {
              throw new Error("INVALID_SCHEMA_FORMAT: Response was not a JSON array.");
            }
            // Add unique ID and cost property
            return parsedData.map((order, i) => ({ ...order, id: i, cost: undefined }));
          } catch (error) {
            console.error("Error details:", error);
            // Re-throw to be caught by the App component
            throw error;
          }
        };

        // --- COMPONENTS ---
        const OrderInput = ({ onGenerate, isLoading, onClear }) => {
          const [inputText, setInputText] = useState('');

          const placeholderText = `Paste your raw order data from Fiverr here. For example:
d
dons_downfall
build shopify store...
Nov 10	$200	
In Revision
...`;

          const handleGenerateClick = () => {
            if (inputText.trim()) onGenerate(inputText);
          };

          const handleClearClick = () => {
            setInputText('');
            onClear();
          };

          return (
            <div className="flex flex-col space-y-4 p-4 md:p-6 bg-slate-800/50 rounded-2xl border border-slate-700 shadow-lg">
              <label htmlFor="order-data" className="text-lg font-semibold text-slate-300">Fiverr Order Data</label>
              <textarea
                id="order-data"
                value={inputText}
                onChange={(e) => setInputText(e.target.value)}
                placeholder={placeholderText}
                className="w-full h-96 p-4 bg-slate-900 border border-slate-600 rounded-lg text-sm text-slate-300 focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition-colors duration-200 resize-y"
                disabled={isLoading}
              />
              <div className="flex flex-col sm:flex-row gap-4">
                <button
                  onClick={handleGenerateClick}
                  disabled={isLoading || !inputText.trim()}
                  className="flex-1 inline-flex items-center justify-center px-6 py-3 border border-transparent text-base font-medium rounded-md shadow-sm text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-offset-slate-900 focus:ring-indigo-500 disabled:bg-indigo-500/50 disabled:cursor-not-allowed transition-all duration-200"
                >
                  {isLoading ? 'Generating...' : <><SparklesIcon className="w-5 h-5 mr-2" /> Generate Report</>}
                </button>
                <button
                  onClick={handleClearClick}
                  disabled={isLoading}
                  className="inline-flex items-center justify-center px-6 py-3 border border-slate-600 text-base font-medium rounded-md shadow-sm text-slate-300 bg-slate-700 hover:bg-slate-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-offset-slate-900 focus:ring-slate-500 disabled:opacity-50 disabled:cursor-not-allowed transition-all duration-200"
                >
                  <ClearIcon className="w-5 h-5 mr-2" /> Clear
                </button>
              </div>
            </div>
          );
        };

        const StatusBadge = ({ status }) => {
            let colorClass = 'bg-slate-700 text-slate-300 border-slate-600';
            const s = status ? status.toLowerCase() : '';
            
            if (s.includes('complete') || s.includes('delivered')) {
                colorClass = 'bg-emerald-900/40 text-emerald-300 border-emerald-800';
            } else if (s.includes('revision')) {
                colorClass = 'bg-amber-900/40 text-amber-300 border-amber-800';
            } else if (s.includes('progress') || s.includes('active')) {
                colorClass = 'bg-blue-900/40 text-blue-300 border-blue-800';
            } else if (s.includes('cancel')) {
                colorClass = 'bg-rose-900/40 text-rose-300 border-rose-800';
            } else if (s.includes('late')) {
                colorClass = 'bg-red-900/40 text-red-300 border-red-800';
            }

            return (
                <span className={`inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium border ${colorClass}`}>
                    {status}
                </span>
            );
        };

        const ErrorCard = ({ error, onClear }) => {
            if (!error) return null;
            const { title, message, suggestion } = getFriendlyErrorMessage(error);
            
            return (
                <div className="rounded-md bg-red-900/20 p-4 border border-red-800/50 animate-fadeIn my-4">
                    <div className="flex">
                        <div className="flex-shrink-0">
                            <AlertIcon className="h-5 w-5 text-red-400" />
                        </div>
                        <div className="ml-3 flex-1">
                            <h3 className="text-sm font-medium text-red-300">{title}</h3>
                            <div className="mt-2 text-sm text-red-400/90">
                                <p>{message}</p>
                            </div>
                            <div className="mt-1 text-xs text-red-400/70">
                                <p>{suggestion}</p>
                            </div>
                        </div>
                        <div className="ml-auto pl-3">
                          <div className="-mx-1.5 -my-1.5">
                            <button
                              type="button"
                              onClick={onClear}
                              className="inline-flex rounded-md p-1.5 text-red-400 hover:bg-red-900/40 focus:outline-none focus:ring-2 focus:ring-red-600 focus:ring-offset-2 focus:ring-offset-red-50 transition-colors"
                            >
                              <span className="sr-only">Dismiss</span>
                              <ClearIcon className="h-4 w-4" />
                            </button>
                          </div>
                        </div>
                    </div>
                </div>
            );
        };

        const ReportTable = ({ data, onUpdatePkr }) => {
            const totalValue = useMemo(() => {
                return data.reduce((sum, item) => sum + (Number(item.value) || 0), 0);
            }, [data]);
            
            const totalValuePKR = useMemo(() => {
                return data.reduce((sum, item) => sum + (Number(item.valuePKR) || 0), 0);
            }, [data]);

            const downloadPDF = () => {
                const doc = new jsPDF();
                
                doc.setFontSize(18);
                doc.setTextColor(40);
                doc.text("Fiverr Order Report", 14, 22);
                
                doc.setFontSize(11);
                doc.setTextColor(100);
                doc.text(`Generated on ${new Date().toLocaleDateString()}`, 14, 30);
                
                const tableBody = data.map(row => [
                    row.date,
                    row.clientName,
                    row.description,
                    row.status,
                    `$${Number(row.value).toFixed(2)}`,
                    `Rs ${Number(row.valuePKR).toLocaleString()}`
                ]);

                autoTable(doc, {
                    startY: 40,
                    head: [['Date', 'Client', 'Description', 'Status', 'Value ($)', 'Value (PKR)']],
                    body: tableBody,
                    foot: [['', '', '', 'Total', `$${totalValue.toFixed(2)}`, `Rs ${totalValuePKR.toLocaleString()}`]],
                    theme: 'grid',
                    headStyles: { fillColor: [79, 70, 229] }, // Indigo 600
                    footStyles: { fillColor: [241, 245, 249], textColor: [15, 23, 42] }, // Slate 100
                    styles: { fontSize: 10, cellPadding: 3 },
                    columnStyles: {
                        4: { halign: 'right' }, // Value $
                        5: { halign: 'right', fontStyle: 'bold' } // Value PKR
                    }
                });

                doc.save("fiverr_orders.pdf");
            };

            return (
                <div className="animate-fadeIn space-y-4">
                    <div className="flex justify-between items-center">
                        <h2 className="text-xl font-semibold text-white">Report Preview</h2>
                        <button 
                            onClick={downloadPDF}
                            className="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-emerald-600 hover:bg-emerald-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-offset-slate-900 focus:ring-emerald-500 transition-colors shadow-emerald-900/20"
                        >
                            <DownloadIcon className="w-4 h-4 mr-2" /> Download PDF
                        </button>
                    </div>
                    
                    <div className="bg-slate-800 rounded-lg shadow-lg overflow-hidden border border-slate-700">
                        <div className="overflow-x-auto">
                            <table className="min-w-full divide-y divide-slate-700">
                                <thead className="bg-slate-700/50">
                                    <tr>
                                        <th scope="col" className="px-6 py-3 text-left text-xs font-medium text-slate-300 uppercase tracking-wider">Date</th>
                                        <th scope="col" className="px-6 py-3 text-left text-xs font-medium text-slate-300 uppercase tracking-wider">Client</th>
                                        <th scope="col" className="px-6 py-3 text-left text-xs font-medium text-slate-300 uppercase tracking-wider">Description</th>
                                        <th scope="col" className="px-6 py-3 text-left text-xs font-medium text-slate-300 uppercase tracking-wider">Status</th>
                                        <th scope="col" className="px-6 py-3 text-right text-xs font-medium text-slate-300 uppercase tracking-wider">Value ($)</th>
                                        <th scope="col" className="px-6 py-3 text-right text-xs font-medium text-slate-300 uppercase tracking-wider">Value (PKR)</th>
                                    </tr>
                                </thead>
                                <tbody className="bg-slate-800 divide-y divide-slate-700">
                                    {data.map((order, idx) => (
                                        <tr key={idx} className="hover:bg-slate-700/30 transition-colors duration-150">
                                            <td className="px-6 py-4 whitespace-nowrap text-sm text-slate-300 font-mono">{order.date}</td>
                                            <td className="px-6 py-4 whitespace-nowrap text-sm font-medium text-white">{order.clientName}</td>
                                            <td className="px-6 py-4 text-sm text-slate-400 max-w-xs truncate" title={order.description}>{order.description}</td>
                                            <td className="px-6 py-4 whitespace-nowrap">
                                                <StatusBadge status={order.status} />
                                            </td>
                                            <td className="px-6 py-4 whitespace-nowrap text-sm text-right text-emerald-400 font-mono font-medium">
                                                ${Number(order.value).toFixed(2)}
                                            </td>
                                            <td className="px-6 py-4 whitespace-nowrap text-sm text-right font-mono">
                                                <input 
                                                    type="number" 
                                                    className="themed-input w-24 text-right text-sm"
                                                    value={order.valuePKR}
                                                    onChange={(e) => onUpdatePkr(idx, e.target.value)}
                                                />
                                            </td>
                                        </tr>
                                    ))}
                                </tbody>
                                <tfoot className="bg-slate-700/30 font-semibold border-t border-slate-700">
                                    <tr>
                                        <td colSpan={4} className="px-6 py-4 text-sm text-slate-300 text-right uppercase tracking-wider">Total Revenue</td>
                                        <td className="px-6 py-4 text-sm text-right text-emerald-400 font-mono text-base shadow-inner bg-slate-700/20">${totalValue.toFixed(2)}</td>
                                        <td className="px-6 py-4 text-sm text-right text-emerald-400 font-mono text-base shadow-inner bg-slate-700/20">Rs {totalValuePKR.toLocaleString()}</td>
                                    </tr>
                                </tfoot>
                            </table>
                        </div>
                    </div>
                </div>
            );
        };

        const App = () => {
            const [orderData, setOrderData] = useState(null);
            const [isLoading, setIsLoading] = useState(false);
            const [error, setError] = useState(null);

            const handleGenerate = async (text) => {
                setIsLoading(true);
                setError(null);
                setOrderData(null);
                try {
                    const data = await parseOrderData(text);
                    // Add PKR value (estimated)
                    const enrichedData = data.map(item => ({
                        ...item,
                        valuePKR: Math.round((item.value || 0) * EXCHANGE_RATE)
                    }));
                    setOrderData(enrichedData);
                } catch (err) {
                    setError(err);
                } finally {
                    setIsLoading(false);
                }
            };

            const handleUpdatePkr = (index, newValue) => {
                setOrderData(prevData => {
                    const newData = [...prevData];
                    newData[index] = { ...newData[index], valuePKR: newValue };
                    return newData;
                });
            };

            const handleClear = () => {
                setOrderData(null);
                setError(null);
            };

            return (
                <div className="min-h-screen bg-slate-900 text-slate-200 py-12 px-4 sm:px-6 lg:px-8 font-sans">
                    <div className="max-w-5xl mx-auto space-y-8">
                        <header className="text-center space-y-3">
                            <h1 className="text-4xl font-extrabold tracking-tight text-white sm:text-5xl">
                                <span className="text-transparent bg-clip-text bg-gradient-to-r from-indigo-400 to-cyan-400">Fiverr</span> Order Report
                            </h1>
                            <p className="text-lg text-slate-400 max-w-2xl mx-auto">
                                Paste your raw order history and let AI transform it into a clean, professional report ready for export.
                            </p>
                        </header>

                        <main className="space-y-6">
                            <OrderInput onGenerate={handleGenerate} isLoading={isLoading} onClear={handleClear} />
                            
                            <ErrorCard error={error} onClear={() => setError(null)} />

                            {orderData && (
                                <div className="mt-8">
                                    <ReportTable data={orderData} onUpdatePkr={handleUpdatePkr} />
                                </div>
                            )}
                        </main>
                        
                        <footer className="text-center text-slate-600 text-sm mt-12 pt-8 border-t border-slate-800">
                            <p>Powered by Google Gemini 2.5 Flash</p>
                        </footer>
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>